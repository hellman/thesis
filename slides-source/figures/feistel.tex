\scalebox{0.8}{
\begin{tikzpicture}

    % First two rounds
    \node[draw,thick,minimum width=1cm] (f1) at ($1*(0,-1.5cm)$)  {$f$};
    \node (xor1) [XOR, left of = f1, node distance = 2cm] {};
    \draw[thick,-latex] (f1) -- (xor1);

    \node[draw,thick,minimum width=1cm] (f2) at ($2*(0,-1.5cm)$)  {$f$};
    \node (xor2) [XOR, left of = f2, node distance = 2cm] {};
    \draw[thick,-latex] (f2) -- (xor2);

    \draw[thick,latex-latex] (f1.east) -| +(1.5cm,-0.5cm) -- ($(xor1) - (0,1cm)$) -- ($(xor1.north) - (0,1.5cm)$);
    \draw[thick] (xor1.south) -- ($(xor1)+(0,-0.5cm)$) -- ($(f1.east) + (1.5cm,-1cm)$) -- +(0,-0.5cm);

    \draw[thick,latex-] (f2.east) -| +(1.5cm,-0.5cm) -- ($(xor2) - (0,1cm)$);
    \draw[thick] (xor2.south) -- ($(xor2)+(0,-0.5cm)$) -- ($(f2.east) + (1.5cm,-1cm)$);

    \draw[thick, densely dotted] ($(f2.east) + (1.5cm,-1cm)$) -- +(0,-0.5cm);
    \draw[thick, densely dotted] ($(xor2) - (0,1cm)$) -- ($(xor2.north) - (0,1.5cm)$);

    % Middle text
    % \node at (0,-4.5cm) {\scriptsize{for 16 rounds}};

    % Last two rounds
    \node[draw,thick,minimum width=1cm] (f3) at ($3*(0,-1.5cm) + (0, -.75cm)$)  {$f$};
    \node (xor3) [XOR, left of = f3, node distance = 2cm] {};
    \draw[thick,-latex] (f3) -- (xor3);

    \node[draw,thick,minimum width=1cm] (f4) at ($4*(0,-1.5cm) + (0, -.75cm)$)  {$f$};
    \node (xor4) [XOR, left of = f4, node distance = 2cm] {};
    \draw[thick,-latex] (f4) -- (xor4);

    \draw[thick,latex-latex] (f3.east) -| +(1.5cm,-0.5cm) -- ($(xor3) - (0,1cm)$) -- ($(xor3.north) - (0,1.5cm)$);
    \draw[thick] (xor3.south) -- ($(xor3)+(0,-0.5cm)$) -- ($(f3.east) + (1.5cm,-1cm)$) -- +(0,-0.5cm);

    \draw[thick, densely dotted] ($(f3.east) + (1.5cm,0cm)$) -- +(0cm,0.5cm);
    \draw[thick, densely dotted] (xor3.north) -- +(0cm,0.35cm);

    %% Inputs
    % \node (p0) [draw,thick,above of = f1, minimum width=5cm,minimum height=0.5cm,node distance=1cm] {$IP$};
    \node (l0) [above of = xor1,node distance=1cm] {$L$};
    \node (r0) [right of = l0, node distance = 4cm] {$R$};
    \draw[thick,-latex] (l0) -- (xor1.north);
    % \draw[thick,-latex] (l0 |- p0.south) -- (xor1.north);
    \draw[thick] ($(f1.east)+(1.5cm,0)$) -- +(0,0.75cm);

    % \draw[thick,latex-] (l0 |- p0.north) -- (l0);
    % \draw[thick,latex-] (r0 |- p0.north) -- (r0);

    %% Outputs
    % \node (p4) [draw,thick,below of = f4, minimum width=5cm,minimum height=0.5cm,node distance=1cm] {$FP$};
    \node (l4) [below of = xor4,node distance=1cm] {$L'$};
    \node (r4) [right of = l4, node distance = 4cm] {$R'$};
    \draw[thick,latex-latex] (f4.east) -| +(1.5cm,-0.75cm);
    \draw[thick,-latex] (xor4.south) -- ($(xor4)+(0,-0.75cm)$);

    % \draw[thick,-latex] (l4 |- p4.south) -- (l4);
    % \draw[thick,-latex] (r4 |- p4.south) -- (r4);

\end{tikzpicture}

% \begin{tikzpicture}
%     \foreach \z in {1, 2,...,3} {
%         \node[draw,thick,minimum width=1cm] (f\z) at ($\z*(0,-1.5cm)$)  {$f_\z$};
%         \node (xor\z) [XOR, left of = f\z, node distance = 2cm, scale=0.8] {};
%         \draw[thick,-latex] (f\z) -- (xor\z);
%     }
%     \foreach \z in {1, 2} {
%         \draw[thick,latex-latex] (f\z.east) -| +(1.5cm,-0.5cm) -- ($(xor\z) - (0,1cm)$) -- ($(xor\z.north) - (0,1.5cm)$);
%         \draw[thick] (xor\z.south) -- ($(xor\z)+(0,-0.5cm)$) -- ($(f\z.east) + (1.5cm,-1cm)$) -- +(0,-0.5cm);
%     }

%     %% Inputs
%     \node (p0) [above of = f1, minimum width=5cm,minimum height=0.5cm,node distance=1cm] {};
%     \node (l0) [above of = xor1,node distance=1cm] {$L_0$};
%     \node (r0) [right of = l0, node distance = 4cm] {$R_0$};
%     \draw[thick,-latex] (l0 |- p0.south) -- (xor1.north);
%     \draw[thick] ($(f1.east)+(1.5cm,0)$) -- +(0,0.75cm);

%     %% Outputs
%     \node (p3) [below of = f3, minimum width=5cm,minimum height=0.5cm,node distance=1.75cm] {};
%     \node (l3) [below of = xor3,node distance=1.75cm] {$L_3$};
%     \node (r3) [right of = l3, node distance = 4cm] {$R_3$};
%     \draw[thick,latex-latex] (f3.east) -| +(1.5cm,-0.5cm) -- ($(xor3) - (0,1cm)$) -- (xor3 |- p3.north);
%     \draw[thick,-latex] (xor3.south) -- ($(xor3)+(0,-0.5cm)$) -- ($(f3.east) + (1.5cm,-1cm)$) -- +(0,-0.5cm);

% \end{tikzpicture}
}
